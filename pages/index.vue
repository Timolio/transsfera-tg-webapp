<script setup lang="ts">
import type { FormData } from '~/types/types';
import { CalendarDate, today, getLocalTimeZone } from '@internationalized/date';

const { useWebApp, MainButton, BackButton } = await import('vue-tg');

const { sendData } = useWebApp();

const currentStep = ref(0);
const totalSteps = ref(3);

const formData = ref<FormData>({
    date: null,
    time: null,
    passengers: 1,
    from: '',
    to: '',
});

const confirm = () => {
    const dataToSend = {
        from: formData.value.from,
        to: formData.value.to,
        date: formData.value.date?.toString(),
        time: formData.value.time,
        passengers: formData.value.passengers,
        timestamp: new Date().toString(),
    };

    sendData(JSON.stringify(dataToSend));
};

const canProceed = computed(() => {
    switch (currentStep.value) {
        case 0:
            return formData.value.date && formData.value.time;
        case 1:
            return formData.value.from.trim() && formData.value.to.trim();
        case 2:
            return formData.value.passengers > 0;
        default:
            return true;
    }
});

const nextStep = () => {
    if (currentStep.value < totalSteps.value) {
        currentStep.value++;
    } else {
        confirm();
    }
};

const prevStep = () => {
    if (currentStep.value > 0) {
        currentStep.value--;
    }
};

const minDate = today(getLocalTimeZone());

const buttonText = computed(() => {
    return currentStep.value === totalSteps.value ? '–ì–æ—Ç–æ–≤–æ' : '–î–∞–ª–µ–µ';
});
</script>

<template>
    <div class="min-h-screen p-5 bg-app-bg max-w-lg mx-auto flex flex-col">
        <div class="mb-8 flex gap-4 items-center sticky top-0">
            <img class="h-10 w-10" src="/logo.png" />
            <UProgress status v-model="currentStep" :max="totalSteps" />
        </div>

        <div class="flex-1 flex flex-col">
            <div v-if="currentStep === 0" class="space-y-6 flex-1">
                <!-- <div class="p-3 rounded-2xl border border-app-border-accented">
                    <div class="flex items-center gap-2 text-app-subtitle">
                        <Icon
                            name="heroicons:information-circle"
                            class="w-5 h-5"
                        />
                        <span class="text-sm font-medium">
                            –î–∞—Ç—É –∏ –≤—Ä–µ–º—è —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ üá™üá∏ –≤—Ä–µ–º–µ–Ω–∏!
                        </span>
                    </div>
                </div> -->
                <div>
                    <div
                        class="uppercase font-medium text-app-subtitle ml-2 mb-1"
                    >
                        –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É
                    </div>
                    <div
                        class="bg-app-bg-accented p-4 rounded-2xl border border-app-border-accented"
                    >
                        <UCalendar
                            v-model="formData.date"
                            size="xl"
                            :year-controls="false"
                            :min-value="minDate"
                        />
                    </div>
                </div>

                <div v-if="formData.date" class="flex items-center gap-2">
                    <div
                        class="uppercase font-medium text-app-subtitle ml-2 mb-1"
                    >
                        –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è
                    </div>
                    <TimePicker v-model="formData.time!" />
                </div>
            </div>

            <div v-if="currentStep === 1" class="space-y-6 flex-1">
                <div>
                    <div
                        class="uppercase font-medium text-app-subtitle ml-2 mb-1"
                    >
                        –û—Ç–∫—É–¥–∞
                    </div>
                    <UInput
                        class="w-full"
                        v-model="formData.from"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
                        size="xl"
                        :ui="{
                            base: 'rounded-2xl',
                        }"
                    />
                </div>

                <div>
                    <div
                        class="uppercase font-medium text-app-subtitle ml-2 mb-1"
                    >
                        –ö—É–¥–∞
                    </div>
                    <UInput
                        class="w-full"
                        v-model="formData.to"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
                        size="xl"
                        :ui="{
                            base: 'rounded-2xl',
                        }"
                    />
                </div>
            </div>

            <div v-if="currentStep === 2" class="space-y-6 flex-1">
                <div>
                    <div
                        class="uppercase font-medium text-app-subtitle ml-2 mb-1"
                    >
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤
                    </div>
                    <UInputNumber
                        size="xl"
                        class="w-full"
                        type="number"
                        :ui="{ base: ['rounded-2xl'] }"
                        v-model="formData.passengers"
                    />
                </div>
            </div>

            <div v-if="currentStep === 3" class="space-y-6 flex-1">
                <div class="p-3 rounded-2xl border border-app-border-accented">
                    <div class="flex items-center gap-2 text-app-subtitle">
                        <Icon
                            name="heroicons:information-circle"
                            class="w-5 h-5"
                        />
                        <span class="text-sm font-medium">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π!
                        </span>
                    </div>
                </div>
                <div class="space-y-2">
                    <div>
                        <strong>–î–∞—Ç–∞:</strong> {{ formData.date?.toString() }}
                    </div>
                    <div><strong>–í—Ä–µ–º—è:</strong> {{ formData.time }}</div>
                    <div><strong>–û—Ç–∫—É–¥–∞:</strong> {{ formData.from }}</div>
                    <div><strong>–ö—É–¥–∞:</strong> {{ formData.to }}</div>
                    <div>
                        <strong>–ü–∞—Å—Å–∞–∂–∏—Ä–æ–≤:</strong> {{ formData.passengers }}
                    </div>
                </div>
            </div>
            <button @click="nextStep">next</button>
        </div>
    </div>

    <MainButton
        :text="buttonText"
        :visible="!!canProceed"
        @click="nextStep"
        color="#e7c380"
    />
    <BackButton :visible="currentStep > 0" @click="prevStep" />
</template>
